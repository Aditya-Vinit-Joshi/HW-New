{% extends 'base.html' %}
{% load static %}

{% block title %}AI Assistant - AI Learning Hub{% endblock %}

{% block extra_css %}
<style>
.chat-container {
    height: calc(100vh - 250px);
    min-height: 500px;
}

.chat-messages {
    height: calc(100% - 100px);
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}

.message {
    margin-bottom: 1rem;
    max-width: 80%;
}

.message.user {
    margin-left: auto;
}

.message.assistant {
    margin-right: auto;
}

.message .content {
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    display: inline-block;
}

.message.user .content {
    background: #007bff;
    color: white;
    border-top-right-radius: 0.25rem;
}

.message.assistant .content {
    background: #e9ecef;
    color: #212529;
    border-top-left-radius: 0.25rem;
}

.message .meta {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.chat-input {
    margin-top: 1rem;
}

.typing-indicator {
    display: none;
    padding: 0.5rem;
    color: #6c757d;
}

.typing-indicator.active {
    display: block;
}

.code-block {
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 1rem;
    border-radius: 0.25rem;
    margin: 0.5rem 0;
    overflow-x: auto;
}

.resource-suggestion {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.75rem;
    margin: 0.5rem 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card chat-container">
                <div class="card-header">
                    <h3 class="mb-0">
                        <i class="fas fa-robot"></i> AI Assistant
                    </h3>
                </div>
                <div class="card-body p-0">
                    <div class="chat-messages" id="chat-messages">
                        <!-- Welcome Message -->
                        <div class="message assistant">
                            <div class="content">
                                <p>ðŸ‘‹ Hi! I'm your AI learning assistant. I can help you with:</p>
                                <ul>
                                    <li>Finding learning resources</li>
                                    <li>Answering questions about AI topics</li>
                                    <li>Providing code examples and explanations</li>
                                    <li>Suggesting learning paths</li>
                                </ul>
                                <p>How can I help you today?</p>
                            </div>
                            <div class="meta">AI Assistant</div>
                        </div>
                        
                        {% for message in chat_history %}
                            <div class="message {% if message.is_user %}user{% else %}assistant{% endif %}">
                                <div class="content">
                                    {{ message.content|linebreaks }}
                                    {% if message.resources %}
                                        <div class="resource-suggestions">
                                            <h6>Related Resources:</h6>
                                            {% for resource in message.resources %}
                                                <div class="resource-suggestion">
                                                    <a href="{% url 'resources:resource_detail' resource.pk %}" target="_blank">
                                                        {{ resource.title }}
                                                    </a>
                                                    <small class="text-muted d-block">
                                                        {{ resource.description|truncatewords:20 }}
                                                    </small>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="meta">
                                    {{ message.timestamp|date:"g:i A" }}
                                </div>
                            </div>
                        {% endfor %}
                        
                        <div class="typing-indicator" id="typing-indicator">
                            <i class="fas fa-circle-notch fa-spin"></i> AI Assistant is typing...
                        </div>
                    </div>
                    
                    <div class="chat-input px-3 pb-3">
                        <form id="chat-form" method="POST" action="{% url 'chatbot:chat' %}">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="text" id="user-input" name="message" class="form-control" 
                                       placeholder="Type your message..." required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Send
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Scroll to bottom of chat
    function scrollToBottom() {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    scrollToBottom();

    // Handle form submission
    $('#chat-form').on('submit', function(e) {
        e.preventDefault();
        
        const form = $(this);
        const input = $('#user-input');
        const message = input.val().trim();
        
        if (!message) return;

        // Add user message
        const userMessage = `
            <div class="message user">
                <div class="content">${message}</div>
                <div class="meta">${new Date().toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'})}</div>
            </div>
        `;
        $('#chat-messages').append(userMessage);
        scrollToBottom();
        
        // Clear input
        input.val('');
        
        // Show typing indicator
        $('#typing-indicator').addClass('active');
        
        // Send message to server
        $.ajax({
            url: form.attr('action'),
            method: 'POST',
            data: {
                message: message,
                csrfmiddlewaretoken: form.find('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function(response) {
                // Hide typing indicator
                $('#typing-indicator').removeClass('active');
                
                // Add AI response
                const aiMessage = `
                    <div class="message assistant">
                        <div class="content">
                            ${response.message}
                            ${response.resources ? `
                                <div class="resource-suggestions">
                                    <h6>Related Resources:</h6>
                                    ${response.resources.map(resource => `
                                        <div class="resource-suggestion">
                                            <a href="/resources/${resource.id}/" target="_blank">
                                                ${resource.title}
                                            </a>
                                            <small class="text-muted d-block">
                                                ${resource.description}
                                            </small>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        <div class="meta">AI Assistant</div>
                    </div>
                `;
                $('#chat-messages').append(aiMessage);
                scrollToBottom();
            },
            error: function() {
                // Hide typing indicator
                $('#typing-indicator').removeClass('active');
                
                // Show error message
                const errorMessage = `
                    <div class="message assistant">
                        <div class="content">
                            Sorry, I encountered an error. Please try again.
                        </div>
                        <div class="meta">AI Assistant</div>
                    </div>
                `;
                $('#chat-messages').append(errorMessage);
                scrollToBottom();
            }
        });
    });
});
</script>
{% endblock %} 